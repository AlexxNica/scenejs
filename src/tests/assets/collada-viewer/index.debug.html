<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>SceneJS Prototype COLLADA Viewer</title>
    <script src="jquery-1.3.2.min.js" type="text/javascript"></script>
    <script src="jquery.url.min.js" type="text/javascript"></script>

    <script src="sylvester.js" type="text/javascript"></script>

    <!-- Core -->

    <script type="application/x-javascript" src="../../../scenejs/core/core.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/core/math.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/core/webgl.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/node/node.js"></script>

    <!-- Exceptions -->

    <script type="application/x-javascript" src="../../../scenejs/exceptions/exceptions.js"></script>


    <!-- Events -->

    <script type="application/x-javascript" src="../../../scenejs/events/eventsModule.js"></script>

    <!-- Errors -->

    <script type="application/x-javascript" src="../../../scenejs/errors/errorsModule.js"></script>

    <!-- Time -->

    <script type="application/x-javascript" src="../../../scenejs/time/timeModule.js"></script>

    <!-- Logger -->

    <script type="application/x-javascript" src="../../../scenejs/logging/loggingModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/logging/logging.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/logging/loggingToPage.js"></script>

    <!-- Process management -->

    <script type="application/x-javascript" src="../../../scenejs/processes/processModule.js"></script>

    <!-- Assets -->

    <script type="application/x-javascript" src="../../../scenejs/load/loadModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/load/load.js"></script>

    <!-- Picking -->

    <script type="application/x-javascript" src="../../../scenejs/pick/pickModule.js"></script>

    <!-- Third-party lib : WebGL Trace -->

    <script type="application/x-javascript" src="../../../scenejs/core/webgl-trace.js"></script>


    <!-- Scene -->

    <script type="application/x-javascript" src="../../../scenejs/scene/sceneModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/scene/scene.js"></script>


    <!-- Memory manager -->

    <script type="application/x-javascript" src="../../../scenejs/memory/memoryModule.js"></script>


    <!-- Shading -->

    <script type="application/x-javascript" src="../../../scenejs/shading/shadingModule.js"></script>


    <!-- Renderer -->
    <!-- Depends on shaders because it enables simple shader by default for new canvas activation -->

    <script type="application/x-javascript" src="../../../scenejs/renderer/rendererModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/renderer/renderer.js"></script>

    <!-- Geometry -->

    <script type="application/x-javascript" src="../../../scenejs/geometry/geometryModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/geometry/geometry.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/geometry/objects/teapot.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/geometry/objects/cube.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/geometry/objects/sphere.js"></script>

    <!-- Modelling transforms -->

    <script type="application/x-javascript"
            src="../../../scenejs/transformation/model/modelTransformModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/model/rotate.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/model/translate.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/model/scale.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/model/modelMatrix.js"></script>

    <!-- Projection transforms -->

    <script type="application/x-javascript"
            src="../../../scenejs/transformation/projection/projectionModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/projection/perspective.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/projection/ortho.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/projection/frustum.js"></script>

    <!-- Viewing transforms -->

    <script type="application/x-javascript" src="../../../scenejs/transformation/view/viewTransformModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/boundary/viewLocalityModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/view/lookAt.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/view/stationary.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/transformation/view/viewMatrix.js"></script>

    <!-- Lighting -->

    <script type="application/x-javascript" src="../../../scenejs/lighting/lightingModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/lighting/lights.js"></script>

    <!-- Material -->

    <script type="application/x-javascript" src="../../../scenejs/material/material.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/material/materialModule.js"></script>


    <!-- Interpolation -->

    <script type="application/x-javascript" src="../../../scenejs/interpolation/scalarInterpolator.js"></script>

    <!-- Scope -->

    <script type="application/x-javascript" src="../../../scenejs/withData/withData.js"></script>

    <!-- Generation -->

    <script type="application/x-javascript" src="../../../scenejs/generation/generator.js"></script>

    <!-- Axis-aligned bounding boxes -->

    <script type="application/x-javascript" src="../../../scenejs/boundary/viewFrustumModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/boundary/boundingBox.js"></script>


    <script type="application/x-javascript" src="../../../scenejs/texture/textureModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/texture/texture.js"></script>

    <script type="application/x-javascript" src="../../../scenejs/fog/fogModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/fog/fog.js"></script>

    <script type="application/x-javascript" src="../../../scenejs/loadCollada/colladaParserModule.js"></script>
    <script type="application/x-javascript" src="../../../scenejs/loadCollada/loadCollada.js"></script>
</head>

<body>
<table>
    <tr>
        <td valign="top">
            <canvas id="theCanvas" width="900" height="900">
                <p>This example requires a browser that supports the
                    <a href="http://www.w3.org/html/wg/html5/">HTML5</a>
                    &lt;canvas&gt; feature.</p>
            </canvas>
        </td>
        <td valign="top">
            <h1>COLLADA Viewer Prototype</h1>

            <h3>Logging</h3>

            <div id="_scenejs-default-logging"></div>
        </td>
    </tr>
</table>


</body>

<script type="text/javascript">

    /**
     * Returns fresh scene graph that will import an optional target asset from the given COLLADA file.
     * The scene accepts eye distance and model yaw/pitch as dynamic configs to pass in on each render, like so:
     *
     * var myScene = createScene("myCanvas", "/http://foo.com/models/myModel.dae", "teapot")
     *
     * myScene.render({
     *        eyeZ: -100,
     *        yaw: 45,
     *        pitch: 20
     *      });
     *
     */
    function createScene(canvasId, colladaURL, colladaNode) {

        return SceneJS.scene({

            canvasId: canvasId,

            proxy:"http://scenejs.org/cgi-bin/jsonp_proxy.pl" }, // Proxy to mediate load

            //                SceneJS.perspective({  // Perspective transform
            //                    fovy : 55.0,
            //                    aspect : 1.0,
            //                    near : 0.10,
            //                    far : 4000.0 },

            //                        SceneJS.lookAt(function(data) { // View transform, eye driven by mouse
            //                            return {
            //                                eye : {z : data.get("eyeZ") || -100.0 },
            //                                look : { x: 0.0, y: 0, z: 1.0 },
            //                                up : { y: 1.0 }
            //                            };
            //                        },
                SceneJS.lights({  // Lighting
                    sources: [
                        {
                            type:                   "dir",
                            color:                  { r: 1.0, g: 1.0, b: 1.0 },
                            dir:                    { x: 1.0, y: -1.0, z: 1.0 },
                            diffuse:                true,
                            specular:               true
                        },
                        {
                            type:                   "dir",
                            color:                  { r: 1.0, g: 1.0, b: 1.0 },
                            dir:                    { x: -1.0, y: -1.0, z: -3.0 },
                            diffuse:                true,
                            specular:               true
                        }
                    ]},

                    // TODO: parse lookat from dae to orient the model

                    /* Next, modelling transforms to orient our model.  Params for these
                     * transforms are dynamically configured from data injected into the
                     * scene graph when its rendered:
                     */

                        SceneJS.rotate(function(data) {
                            return {
                                angle: data.get('pitch'), x : 1.0
                            };
                        },
                                SceneJS.rotate(function(data) {
                                    return {
                                        angle: data.get('yaw'), y : 1.0
                                    };
                                },
                                        SceneJS.loadCollada({
                                            uri: colladaURL,
                                            node: colladaNode,
                                            loadCamera: true,
                                            loadLights: true
                                        }))
                                )
                        )
                );
    }

    $(document).ready(function() {

        /* Get params - DAE file location and optional target asset
         */
        var colladaURL = jQuery.url.param("collada-url");
        if (!colladaURL) {
            alert("GET parameter missing: 'collada-url'");
        }

        var colladaNode = jQuery.url.param("collada-node");

        /* Interaction params
         */
        var pInterval;
        var yaw = 0;
        var pitch = 0;
        var lastX;
        var lastY;
        var dragging = false;

        var dist = 30;
        var speed = 0;


        SceneJS.onEvent("error", function(e) {
            window.clearInterval(pInterval);
            var exception = e.exception;
            alert(exception.message ? exception.message : exception);
        });

        var scene = createScene("theCanvas", colladaURL, colladaNode);


        /* Good practice to get canvas from scene - it will look for a
         * defaultly-named canvas if it can't find the one specified, like
         * when you run this in the SceneJS online IDE.
         */
        var canvas = scene.getCanvas();

        /*
         Mouse handlers
         */

        function mouseDown(event) {
            lastX = event.clientX;
            lastY = event.clientY;
            dragging = true;
        }

        function mouseUp() {
            dragging = false;
        }

        function mouseMove(event) {
            if (dragging) {
                yaw += (event.clientX - lastX) * 0.5;
                pitch += (event.clientY - lastY) * 0.5;
                lastX = event.clientX;
                lastY = event.clientY;
            }
        }

        function mouseWheel(event) {
            var delta = 0;
            if (!event) event = window.event;
            if (event.wheelDelta) {
                delta = event.wheelDelta / 120;
                if (window.opera) delta = -delta;
            } else if (event.detail) {
                delta = -event.detail / 3;
            }
            if (delta) {
                if (delta < 0) {
                    speed += 0.5;
                } else {
                    speed -= 0.5;
                }
            }
            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        }

        canvas.addEventListener('mousedown', mouseDown, true);
        canvas.addEventListener('mousemove', mouseMove, true);
        canvas.addEventListener('mouseup', mouseUp, true);
        canvas.addEventListener('mousewheel', mouseWheel, true);

        /* Render func
         */

        window.render = function() {
            dist += speed;
            if (dist < 10) {
                speed = 0;
                dist = 10;
            }
            if (dist > 4000) {
                speed = 0;
                dist = 4000;
            }
            if (pitch < -80) {
                pitch = -80;
            }

            if (pitch > 80) {
                pitch = 80;
            }

            scene.render({
                eyeZ: dist, yaw: yaw, pitch: pitch
            });
        };

        pInterval = setInterval("window.render()", 10);

    });
</script>

</html>