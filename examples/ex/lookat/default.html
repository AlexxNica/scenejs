<!DOCTYPE html>
<html lang="en">
<head>
    <title>SceneJS V3 Basic Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            margin: 0;
            -moz-user-select: -moz-none;
            -khtml-user-select: none;
            -webkit-user-select: none;
        }
    </style>

    <script src="../../../build/latest/scenejs.js"></script>
    <script src="../../../build/latest/extras/controls/orbit.js"></script>
</head>
<body>

<script>

    // A lookAt node defines the viewing transform as the position of the eye,
    // the viewing direction, and the direction of "up".
    //
    // Each scene can have multiple lookAt nodes.
    //
    // If you omit the lookAt node, then the scene will fall back on internal
    // default lookAt settings where the eye is at -10 on the Z-axis, looking
    // towards 0,0,0, with up being 0,1,0.
   //
    // The scene below contains a lookAt that has the same properties as the
    // one that SceneJS provides by default, and is defined here to show them.

    var scene = SceneJS.createScene({
        nodes:[
            {
                type:"lookAt",
                id: "theLookat",
                eye:{ x: 0, y: 0, z:10 },
                look:{ x: 0, y: 0, z:0 },
                up:{ x: 0, y: 1, z:0 },

                nodes:[
                    {
                        type:"geometry",
                        plugin:"teapot"
                    }
                ]
            }
        ]
    });

    // Mouse control stuff follows

    var yaw = 0;
    var pitch = 0;
    var zoom = 10;
    var zoomSensitivity = 1.0;

    var lastX;
    var lastY;
    var dragging = false;

    var lookat = scene.getNode("theLookat");

    var canvas = scene.getCanvas();

    canvas.addEventListener('mousedown', mouseDown, true);
    canvas.addEventListener('mousemove', mouseMove, true);
    canvas.addEventListener('mouseup', mouseUp, true);
    canvas.addEventListener('touchstart', touchStart, true);
    canvas.addEventListener('touchmove', touchMove, true);
    canvas.addEventListener('touchend', touchEnd, true);
    canvas.addEventListener('mousewheel', mouseWheel, true);
    canvas.addEventListener('DOMMouseScroll', mouseWheel, true);

    function mouseDown(event) {
        lastX = event.clientX;
        lastY = event.clientY;
        dragging = true;
    }

    function touchStart(event) {
        lastX = event.targetTouches[0].clientX;
        lastY = event.targetTouches[0].clientY;
        dragging = true;
    }

    function mouseUp() {
        dragging = false;
    }

    function touchEnd() {
        dragging = false;
    }

    function mouseMove(event) {
        var posX = event.clientX;
        var posY = event.clientY;
        actionMove(posX, posY);
    }

    function touchMove(event) {
        var posX = event.targetTouches[0].clientX;
        var posY = event.targetTouches[0].clientY;
        actionMove(posX, posY);
    }

    function actionMove(posX, posY) {
        if (dragging) {
            yaw -= (posX - lastX) * 0.1;
            pitch -= (posY - lastY) * 0.1;
            update();
            lastX = posX;
            lastY = posY;
        }
    }

    function mouseWheel(event) {
        var delta = 0;
        if (!event) event = window.event;
        if (event.wheelDelta) {
            delta = event.wheelDelta / 120;
            if (window.opera) delta = -delta;
        } else if (event.detail) {
            delta = -event.detail / 3;
        }
        if (delta) {
            if (delta < 0) {
                zoom -= zoomSensitivity;
            } else {
                zoom += zoomSensitivity;
            }
        }
        if (event.preventDefault) {
            event.preventDefault();
        }
        event.returnValue = false;
        update();

    }

    function update() {
        var eye = [0, 0, zoom];
        var look = [0, 0, 0];
        var up = [0, 1, 0];
        var eyeVec = SceneJS_math_subVec3(eye, look, []);
        var axis = SceneJS_math_cross3Vec3(up, eyeVec, []);
        var pitchMat = SceneJS_math_rotationMat4v(pitch * 0.0174532925, axis);
        var yawMat = SceneJS_math_rotationMat4v(yaw * 0.0174532925, up);
        var eye3 = SceneJS_math_transformPoint3(pitchMat, eye);
        eye3 = SceneJS_math_transformPoint3(yawMat, eye3);
        lookat.setEye({x:eye3[0], y:eye3[1], z:eye3[2] });
    }

</script>
</body>
</html>