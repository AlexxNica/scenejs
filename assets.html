<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <script>

        if (window.addEventListener) {
            addEventListener("message",
                    function (event) {
                        var client = event.source;
                        var origin = event.origin;
                        var msg;
                        try {
                            msg = JSON.parse(event.data);
                        } catch (e) {
                            console.log("JSON parse failed on an incoming Web message: " + e.message || e);
                            return;
                        }
                        if (msg.connect) {
                            client.postMessage({ ready: true }, origin);
                        }
                        if (msg.get) {
                            getImage(msg.get,
                                    function (data) {
                                        client.postMessage({ id: msg.id, data: data }, origin);
                                    },
                                    function (errMsg) {

                                    });
                        }

                    }, false);
        } else {
            console.error("Browser does not support cross-window messaging");
        }

        function getImage(src, ok, error) {
            var image = new Image();
            image.onload = function () {

                var canvas = document.createElement("canvas");
                var context = canvas.getContext("2d");

                canvas.width = image.width;
                canvas.height = image.height;

                context.drawImage(image, 0, 0, image.width, image.height);

                ok(canvas.toDataURL())
            };
            image.onerror = function () {
                if (error) {
                    error("");
                }
            };
            image.crossOrigin = "Anonymous";
            image.src = src;
        }

    </script>
    <title></title>
</head>
<body>

</body>
</html>