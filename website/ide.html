<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="lib/codemirror/js/codemirror.js" type="text/javascript"></script>
    <script src="lib/codemirror/js/mirrorframe.js" type="text/javascript"></script>
    <title>SceneJS Online IDE</title>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        #file-url {
            width: 600px;
            padding: 10px;
            outline: none;
            height: 36px;
        }

        .focusField {
            border: solid 2px #73A6FF;
            background: #EFF5FF;
            color: #000;
        }

        .idleField {
            background: #EEE;
            color: #6F6F6F;
            border: solid 2px #DFDFDF;
        }
    </style>
</head>
<body style="padding: 20px;">

<script type="text/javascript" src="lib/jquery/jquery-1.3.2.min.js">
</script>
<script type="text/javascript" src="lib/jquery/jquery-url.packed.js">
</script>
<script type="text/javascript" src="lib/jquery/jquery.jtemplates.js">
</script>
<script type="text/javascript" src="lib/sylvester/sylvester.js">
</script>
<script type="text/javascript" src="lib/scenejs/scenejs.min.js">
</script>


<div id="wide-container">
    <div id="header">
        <h1><a href="index.html">SceneJS</a> &gt; <a href="load-ide.html">IDE</a> &gt;&nbsp;<span id="title"></span>
        </h1>

        <a class="a2a_dd" href="http://www.addtoany.com/share_save?linkname=s&amp;linkurl=s"><img
                src="http://static.addtoany.com/buttons/share_save_171_16.png" width="171" height="16" border="0"
                alt="Share/Bookmark"/></a>
        <script type="text/javascript">
            var a2a_linkname = "SceneJS Example";
            var a2a_linkurl = window.location;
            var a2a_onclick = 1;</script>
        <script type="text/javascript" src="http://static.addtoany.com/menu/page.js"></script>
    </div>

    <div id="content">
        <div id="playroom-ide">

        </div>
    </div>
</div>
<div id="footer"><p>All content is copyright (C) 2009 Lindsay Kay, <a href="http://www.xeolabs.com">Xeolabs</a></p>
</div>

<script type="text/javascript">

var scriptEditor;
var lastError = null;

function showStartupError(template, message) {
    $("#playroom-ide").setTemplateURL("templates/messages/error/" + template);
    $("#playroom-ide").processTemplate({ message: message || "" });
}

function showIDE(remoteUrl) {
    $("#playroom-ide").setTemplateURL("templates/ide.html");
    $("#playroom-ide").processTemplate({
        url: remoteUrl,
        truncatedUrl: truncateUrl(remoteUrl)
    });
}

function showFeedback(template, message) {
    $("#output-area").setTemplateURL("templates/messages/feedback/" + template);
    $("#output-area").processTemplate({ message: message || "" });
}

function showError(template, e) {
    $("#output-area").setTemplateURL("templates/messages/error/" + template);
    $("#output-area").processTemplate({ message: e.message || e });
}

function truncateUrl(url) {
    var parts = url.split("/");
    var path;
    if (parts.length <= 4) {
        path = url;
    } else {
        path = "";
        for (var i = 0; i < 3; i++) {
            path += parts[i] + "/";
        }
        path += "..." + url.substring(url.lastIndexOf("/"));
    }
    return(path);
}

function showFileOnPath(title, url) {
    var urlHtml = "&nbsp;<a target=\"other\" href=\"" + url + "\">" + truncateUrl(url) + "</a>";
    if (title) {
        $("#title").append(title);
        $("#url").append(urlHtml);
        $(document).attr("title", "SceneJS IDE > " + title);
    } else {
        $("#title").append(urlHtml);
        $("#url").append("");
    }
}

function showErrorOnPath() {
    $("title").append("Aaaargh!!");
}

function hideRunButton() {
    $("#output-panel-header").empty();
}

function showRunButton() {
    $("#output-panel-header").append("<a href=\"javascript:bla()\"><span id=\"run-button\">Run again</span></a>");
    $('#run-button').click(function() {
        if (lastError) {
            restoreCanvas();
            lastError = null;
        }
        evalScene(scriptEditor.getCode());
    });
}

var handleException = function(e) {
    lastError = e;
    if (e instanceof SceneJS.exceptions.WebGLNotSupportedException) {
        showError("no-webgl.html", e);

    } else if (e instanceof SceneJS.exceptions.NodeBackendInstallFailedException) {
        showError("node-backend-install-failed.html", e);

    } else if (e instanceof SceneJS.exceptions.NodeConfigExpectedException) {
        showError("node-config-expected.html", e);

    } else if (e instanceof SceneJS.exceptions.ShaderLinkFailureException) {
        showError("shader-link-failure.html", e);

    } else if (e instanceof SceneJS.exceptions.ShaderVariableNotFoundException) {
        showError("shader-variable-not-found.html", e);

    } else if (e instanceof SceneJS.exceptions.CanvasNotFoundException) {
        showError("canvas-not-found.html", e);

    } else if (e instanceof SceneJS.exceptions.InvalidLookAtConfigException) {
        showError("invalid-lookat-parameters.html", e);

    } else if (e instanceof SceneJS.exceptions.InvalidGeometryConfigException) {
        showError("illegal-geometry-parameters.html", e);

    } else if (e instanceof SceneJS.exceptions.UnsupportedOperationException) {
        showError("unsupported-operation.html", e);

    } else if (e instanceof SceneJS.exceptions.IllegalRotateConfigException) {
        showError("illegal-rotate-config.html", e);

    } else if (e instanceof SceneJS.exceptions.InvalidNodeConfigException) {
        showError("invalid-node-config.html", e);

    } else if (e instanceof SceneJS.exceptions.AssetLoadFailureException) {
        showError("asset-load-failure.html", e);

    } else if (e instanceof SceneJS.exceptions.OutOfVRAMException) {
        showError("out-of-memory.html", e);

    } else {
        showError("default-error.html", e);
    }
};

function evalScene(text) {
    try {
        restoreCanvas();
        hideRunButton();
        $("#_scenejs-default-logging").text("");
        SceneJS.reset();
        eval(text);
    } catch (e) {
        handleException(e);
    }
    showRunButton();
}

function restoreCanvas() {
    $("#output-area").setTemplateURL("templates/canvas.html");
    $("#output-area").processTemplate({});
}

function jsonp(fullUri, callbackName, onLoad) {
    var head = document.getElementsByTagName("head")[0];
    var script = document.createElement("script");
    script.type = "text/javascript";
    window[callbackName] = function(data) {
        onLoad(data);
        window[callbackName] = undefined;
        try {
            delete window[callbackName];
        } catch(e) {
        }
        head.removeChild(script);
    };
    head.appendChild(script);
    script.src = fullUri;  // Request fires now
}

function loadScene(uri, onSuccess, onError) {
    hideRunButton();
    showFeedback("scene-loading.html", "Loading file: " + uri);
    var proxy = "http://www.scenejs.org/cgi-bin/jsonp_proxy.pl";
    var serverParams = { format: "xml" };
    var callbackName = "callback";
    var url = [proxy, "?callback=", callbackName , "&uri=" + uri];
    for (var param in serverParams) {
        url.push("&", param, "=", serverParams[param]);
    }
    var urlStr = url.join("");
    jsonp(urlStr,
            callbackName,
            function(data) {    // onLoad
                if (!data) {
                    onError("Server response is empty");
                } else if (data.error) {
                    onError("Error from server: " + data.error);
                } else {
                    onSuccess(data);
                }
            });
}


function init(remoteUrl, text) {
    showIDE(remoteUrl);
    scriptEditor = new CodeMirror(CodeMirror.replace("script-text-area"), {
        height: "1000px",
        content: text,
        parserfile: [
            "tokenizejavascript.js",
            "parsejavascript.js"
        ],
        stylesheet: "./lib/codemirror/css/jscolors.css",
        path: "./lib/codemirror/js/",
        autoMatchParens: true,
        textWrapping: false,

        initCallback: function() {
            evalScene(text);
        }
    });
}

$(document).ready(function() {
    var remoteUrl = jQuery.url.param("url");
    if (!remoteUrl) {
        showErrorOnPath();
        showStartupError("illegal-playroom-request.html", "Missing URL parameter: 'url'");
    } else {
        var title = jQuery.url.param("title");
        loadScene(remoteUrl,
                function(text) {
                    var title = jQuery.url.param("title");
                    showFileOnPath(title, remoteUrl);
                    init(remoteUrl, text);
                },
                function(message) {
                    showErrorOnPath();
                    showStartupError("scene-load-failed.html", message);
                });
    }
});

function bla() {

}

</script>

<script type="text/javascript">
    var uservoiceOptions = {
        /* required */
        key: 'scenejs',
        host: 'scenejs.uservoice.com',
        forum: '38232',
        showTab: true,
        /* optional */
        alignment: 'right',
        background_color:'#f00',
        text_color: 'white',
        hover_color: '#06C',
        lang: 'en'
    };

    function _loadUserVoice() {
        var s = document.createElement('script');
        s.setAttribute('type', 'text/javascript');
        s.setAttribute('src', ("https:" == document.location.protocol ? "https://" : "http://") + "cdn.uservoice.com/javascripts/widgets/tab.js");
        document.getElementsByTagName('head')[0].appendChild(s);
    }
    _loadSuper = window.onload;
    window.onload = (typeof window.onload != 'function') ? _loadUserVoice : function() {
        _loadSuper();
        _loadUserVoice();
    };
</script>


<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-8036359-3");
        pageTracker._trackPageview();
    } catch(err) {
    }</script>
</body>
</html>
